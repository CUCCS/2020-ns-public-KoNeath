# 常见蜜罐体验和探索 #
## 实验目的 ##
- 了解蜜罐的分类和基本原理
- 了解不同类型蜜罐的适用场合
- 掌握常见蜜罐的搭建和使用

## 实验环境 ##
- 从 paralax/awesome-honeypots中选择 1 种低交互蜜罐和 1 种中等交互蜜罐进行搭建实验  
 - 推荐 SSH 蜜罐

## 实验要求 ##
- 记录蜜罐的详细搭建过程；
- 使用 nmap 扫描搭建好的蜜罐并分析扫描结果，同时分析「 nmap 扫描期间」蜜罐上记录得到的信息；
- 如何辨别当前目标是一个「蜜罐」？以自己搭建的蜜罐为例进行说明。

## 实验过程 ##
### 实验拓扑结构 ###
- 在Kali-victim1环境中搭建蜜罐，attacker攻击victim1  
  ![](imgs/topology.png)
  
- 网络环境
 - attacker的ip  
   ![](imgs/attacker-ip.png)
 - victim的ip  
   ![](imgs/victim-ip.png)

### 蜜罐解析 ###
- 蜜罐技术本质上是一种对攻击方进行欺骗的技术，通过布置一些作为诱饵的主机、网络服务或者信息，诱使攻击方对它们实施攻击，从而可以对攻击行为进行捕获和分析，了解攻击方所使用的工具与方法，推测攻击意图和动机，能够让防御方清晰地了解他们所面对的安全威胁，并通过技术和管理手段来增强实际系统的安全防护能力。
- 蜜罐好比是情报收集系统。蜜罐好像是故意让人攻击的目标，引诱黑客前来攻击。所以攻击者入侵后，你就可以知道他是如何得逞的，随时了解针对服务器发动的最新的攻击和漏洞。还可以通过窃听黑客之间的联系，收集黑客所用的种种工具，并且掌握他们的社交网络。  

### 蜜罐搭建 ###
- ssh_honeypot搭建  
 - 根据课本中给出的参考资料将ssh_honeypot 克隆到victim本地。  
   ![](imgs/ssh_honeypot-copy.png)
 - 默认22端口给蜜罐使用，编辑配置文件将ssh的端口号改为一个不常用的端口号56，让出22端口位置，然后重启ssh服务。使用命令gedit /etc/ssh/sshd_config；service ssh restart。  
   ![](imgs/ssh-set.png)
 - 安装docker服务并启动。apt-get install docker docker-compose；service docker start。  
   ![](imgs/docker-set.png)
   ![](imgs/docker-start.png)
 - 搭建蜜罐  
   - Make sure libssh and libjson-c are installed
     - apt install libssh-dev libjson-c-dev
   - Build and Run
    - make
     - ssh-keygen -t rsa -f ./ssh-honeypot.rsa
     - bin/ssh-honeypot -r ./ssh-honeypot.rsa  
   ![](imgs/honeypot-set1.png)
   ![](imgs/honeypot-set2.png)
- cowrie搭建  
 - 根据课本给出的参考地址将cowrie克隆到本地   
   ![](imgs/cowrie-copy.png)
 - 下载镜像docker pull cowrie/cowrie  
   ![](imgs/cowrie-pull.png)
 - 运行cowrie，docker run -p 2222:2222 cowrie/cowrie。  

### 使用nmap扫描搭建好的蜜罐并分析扫描结果 ###
- 扫描ssh-Honeypot蜜罐  
 - 攻击者attacker主机尝试和victim1进行ssh连接，观察到输入的测试密码显示在运行蜜罐的victim界面，不论attacker输入的密码正确与否，victim都会拒绝ssh的链接，都会显示 Permission denied,please try again.  
   ![](imgs/atk-ssh-f1.png)
 - 原因是ssh-honeypot是一个低交互式的蜜罐，无法完成ssh连接。
 - 攻击者使用TCP stealth scan、XMAS scan、FIN scan、NULL scan
   - TCP stealth scan
   收到syn-ack，说明端口为打开状态  
   ![](imgs/TCP-stealth-scan.png)
   - XMAS scan
   22端口为打开或过滤状态  
   ![](imgs/XMAS-scan.png)
   - FIN scan
   22端口为打开或过滤状态  
   ![](imgs/FIN-scan.png)
   - Null scan
   22端口为打开或过滤状态  
   ![](imgs/Null-scan.png)
   - 但查看日志，并未发现有新的攻击者行为记录  
 - 因此，ssh-Honeypot作为低交互式蜜罐，仅仅是一个可以简单记录ssh连接请求数据的简易蜜罐，TCP stealth scan、XMAS scan、FIN scan、NULL scan等攻击不会被捕获。  

- 扫描cowrie蜜罐
 - 攻击者attacker主机尝试和victim1进行ssh连接，在victim上用docker run -p 2222:2222 cowrie/cowrie 将蜜罐运行在2222端口，attacker用ssh root@10.0.2.10 -p 2222请求和victim进行ssh连接。，观察到攻击者的ip地址等信息也显示在victim的界面上了，输入密码成功后连接成功。  
   ![](imgs/atk-ssh-s1.png)
   ![](imgs/atk-ssh-s2.png)
 - 攻击者attacker 在连接了ssh后，进行ping百度的操作  
   - 发现操作成功  
   ![](imgs/ping-baidu.png)
 - 攻击者使用TCP stealth scan、XMAS scan、FIN scan、NULL scan
   - TCP stealth scan
   检测被蜜罐记录，记录了attacker的主机ip、端口号、session等信息
   收到syn-ack，说明端口为打开状态  
   ![](imgs/TCP-stealth-scan-s.png)
   - XMAS scan
   victim主机界面没有变化，attacker的扫描没有被记录
   22端口为打开或过滤状态  
   ![](imgs/XMAS-scan-s.png)
   - FIN scan
   victim主机界面没有变化，attacker的扫描没有被记录
   22端口为打开或过滤状态  
   ![](imgs/FIN-scan-s.png)
   - Null scan
   victim主机界面没有变化，attacker的扫描没有被记录
   22端口为打开或过滤状态  
   ![](imgs/Null-scan-s.png)
 - cowrie是一个中等交互蜜罐，可以进行ssh远程连接等真机的操作，TCP stealth sca攻击会被记录，XMAS scan、FIN scan、NULL scan等攻击不会被记录，这个蜜罐提供的命令、错误提示等比较全面，但部分命令的错误输出会暴露这是个 python 蜜罐。

## 总结与收获 ##
- 遇见的困难以及解决方法：
 - 进行蜜罐搭建时报错"bash: bin/ssh-honeypot: 没有那个文件或目录"，原因是没有输入make命令（make命令的作用是进行编译），先输入make后再输入ssh-keygen -t rsa -f ./ssh-honeypot.rsa；bin/ssh-honeypot -r ./ssh-honeypot.rsa两条命令，得以解决。
 - 扫描cowrie蜜罐时Attacker中途中断后重新连接输入ssh root@10.0.2.8 -p 2222报错，错误提示“host key VERIFICATION FAILED”，原因是ssh会把每个访问过计算机的公钥都记录在~/.ssh/known_hosts，当下次访问相同计算机时，OpenSSH会核对公钥。如果公钥不同，OpenSSH会发出警告，避免你受到DNS Hijack之类的攻击。解决方法是清空本地ip密码记录，先进入~/.ssh目录下，然后输入rm known_hosts进行IP记录删除即可。
- 经过此次实验，我了解了蜜罐的分类和基本原理，了解了不同类型蜜罐的适用场合，掌握了常见蜜罐的搭建和使用。进行实际操作后，加深了对书本知识的印象。